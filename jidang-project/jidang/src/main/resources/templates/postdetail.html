<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{index :: layout(~{::content}, ~{::scripts}, ~{::css})}">

<!-- ÌéòÏù¥ÏßÄ Ï†ÑÏö© CSS -->
<th:block th:fragment="css">
    <link rel="stylesheet" th:href="@{/css/postdetail.css}">
</th:block>

<!-- Î≥∏Î¨∏ ÏòÅÏó≠ -->
<div th:fragment="content" class="post-detail-page">

    <!-- Î©îÏù∏ Ïπ¥Îìú -->
    <article class="post-detail-card">

        <!-- ÏÉÅÎã® Ï†ïÎ≥¥ -->
        <header class="post-detail-header">

            <div class="post-detail-meta-top">
                <!-- Ïπ≠Ìò∏ + ÏûëÏÑ±Ïûê -->
                <span class="post-detail-author">

                    <!-- ÏÑ†ÌÉùÎêú Ïπ≠Ìò∏Í∞Ä ÏûàÍ≥† 'ÏÑ†ÌÉùÏïàÌï®'Ïù¥ ÏïÑÎãê ÎïåÎßå -->
                    <span th:if="${post.author != null
                                  and post.author.selectedTitle != null
                                  and post.author.selectedTitle != ''
                                  and post.author.selectedTitle != 'ÏÑ†ÌÉùÏïàÌï®'}"
                          class="author-title">
                        [<span th:text="${post.author.selectedTitle}"></span>]
                    </span>

                    <!-- ÏûëÏÑ±Ïûê ÎãâÎÑ§ÏûÑ -->
                    <span th:text="${post.author != null ? post.author.username : 'Ïïå Ïàò ÏóÜÏùå'}"></span>
                </span>

                <span class="post-detail-dot">¬∑</span>

                <!-- ÏûëÏÑ± ÏãúÍ∞Ñ -->
                <span class="post-detail-time"
                      th:text="${#temporals.format(post.createDate, 'yyyy.MM.dd HH:mm')}">
                    2025.01.01 12:00
                </span>

                <!-- ÏàòÏ†ïÎê® ÌëúÏãú -->
                <span class="post-detail-modified"
                      th:if="${post.modifyDate != null}">
                    (ÏàòÏ†ïÎê®
                    <span th:text="${#temporals.format(post.modifyDate, 'yyyy.MM.dd HH:mm')}"></span>)
                </span>
            </div>

            <!-- Ï†úÎ™© -->
            <h1 class="post-detail-title"
                th:text="${post.subject}">
                Í≤åÏãúÍ∏Ä Ï†úÎ™©
            </h1>

            <!-- ÌÉúÍ∑∏Îì§ -->
            <div class="post-detail-tags">

                <!-- ÌÉúÍ∑∏Í∞Ä ÏûàÏùÑ Îïå -->
                <span class="tag-chip"
                      th:each="pt : ${post.postTags}"
                      th:text="${pt.tag != null ? pt.tag.name : 'ÌÉúÍ∑∏'}">
                    ÌÉúÍ∑∏
                </span>

                <!-- ÌÉúÍ∑∏Í∞Ä ÌïòÎÇòÎèÑ ÏóÜÏùÑ Îïå -->
                <span th:if="${post.postTags == null or #lists.isEmpty(post.postTags)}"
                      class="tag-chip tag-chip-empty">
                    ÌÉúÍ∑∏ ÏóÜÏùå
                </span>
            </div>
        </header>

        <!-- Ïù¥ÎØ∏ÏßÄ -->
        <section class="post-detail-attachment"
                 th:if="${post.images != null and !#lists.isEmpty(post.images)}">

            <div class="post-detail-image-list">
                <img class="post-detail-image"
                     th:each="img : ${post.images}"
                     th:src="@{${img.filepath}}"
                     alt="Ï≤®Î∂Ä Ïù¥ÎØ∏ÏßÄ">
            </div>
        </section>

        <!-- Î≥∏Î¨∏ -->
        <section class="post-detail-body">
            <!-- Ï§ÑÎ∞îÍøà Ïú†ÏßÄ -->
            <p class="post-detail-content"
               th:utext="${#strings.escapeXml(post.content)?.replaceAll('\n', '<br/>')}">
            </p>
        </section>

        <!-- ÌïòÎã® ÌÜµÍ≥Ñ -->
        <section class="post-detail-stats">
            <div class="stat">
                <span class="stat-icon">‚ù§</span>
                <span th:text="${post.liker != null ? #lists.size(post.liker) : 0}">0</span>
            </div>
            <div class="stat">
                <span class="stat-icon">üí¨</span>
                <span th:text="${post.commentsList != null ? #lists.size(post.commentsList) : 0}">0</span>
            </div>
        </section>
    </article>

    <!-- Ïï°ÏÖò Î≤ÑÌäº -->
    <section class="post-detail-actions">

        <!-- Ï¢ãÏïÑÏöî (Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨ÎûåÎßå) -->
        <button type="button"
                id="likeButton"
                class="action-btn"
                th:data-like-url="@{|/post/like/${post.id}|}"
                sec:authorize="isAuthenticated()">
            ‚ù§ Ï¢ãÏïÑÏöî
        </button>

        <!-- ÎåìÍ∏ÄÎ°ú Ïä§ÌÅ¨Î°§ Ïù¥Îèô -->
        <button type="button" class="action-btn" id="commentButton">üí¨ ÎåìÍ∏Ä</button>

        <!-- Í≥µÏú† Î≤ÑÌäº (ÎÇòÏ§ëÏóê Í∏∞Îä• Î∂ôÏùº Ïàò ÏûàÏùå) -->
        <button type="button" class="action-btn" id="shareButton">üì§ Í≥µÏú†</button>
    </section>

    <!-- ==========================================================
         ÎåìÍ∏Ä ÏòÅÏó≠ (Î¨¥Ìïú ÎåÄÎåìÍ∏Ä ÏßÄÏõê Î≤ÑÏ†Ñ)
    =========================================================== -->
    <section class="post-detail-comments">

        <h2 class="comments-title">
            ÎåìÍ∏Ä
            <span class="comments-count"
                  th:text="${post.commentsList != null ? #lists.size(post.commentsList) : 0}">
                0
            </span>
        </h2>

        <!-- ÎåìÍ∏Ä Î™©Î°ù -->
        <div class="comments-list">

            <!-- ÎåìÍ∏Ä ÏóÜÏùÑ Îïå -->
            <p class="comments-empty"
               th:if="${post.commentsList == null || #lists.isEmpty(post.commentsList)}">
                ÏïÑÏßÅ ÎåìÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§. Ï≤´ Î≤àÏß∏ ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!
            </p>

            <!-- ÎåìÍ∏Ä ÏûàÏùÑ Îïå: ÏµúÏÉÅÏúÑ ÎåìÍ∏Ä(parent == null)Î∂ÄÌÑ∞ ÏãúÏûë -->
            <div th:if="${post.commentsList != null && !#lists.isEmpty(post.commentsList)}">

                <!-- üîÅ Ïû¨Í∑Ä fragment Ìò∏Ï∂ú: level = 0 ÏóêÏÑú ÏãúÏûë -->
                <div th:insert="~{::commentThread(${post.commentsList.?[parent == null]}, 0)}"></div>

            </div>
        </div>

        <!-- ÏÉà ÎåìÍ∏Ä ÏûëÏÑ± (ÏµúÏÉÅÏúÑ ÎåìÍ∏Ä) -->
        <form class="comment-form"
              th:action="@{|/comments/create/${post.id}|}"
              th:object="${commentsForm}"
              method="post"
              sec:authorize="isAuthenticated()">

            <input type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}"/>

            <textarea class="comment-textarea"
                      th:field="*{content}"
                      placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                      rows="3"></textarea>

            <div class="comment-form-footer">
                <button type="submit" class="comment-submit-btn">ÏûëÏÑ±</button>
            </div>
        </form>

        <!-- ÎπÑÎ°úÍ∑∏Ïù∏ ÏÉÅÌÉúÏùº Îïå ÏïàÎÇ¥ Î¨∏Íµ¨ -->
        <p class="comments-empty"
           sec:authorize="isAnonymous()">
            ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.
        </p>

        <!-- ==================================================================
             üîÅ Ïû¨Í∑Ä fragment: ÎåìÍ∏Ä 1Í∞ú + Í∑∏ ÏûêÏãùÎì§ÏùÑ Í≥ÑÏÜçÌï¥ÏÑú Ï∂úÎ†•ÌïòÎäî Ïó≠Ìï†
             - params:
               - comments : ÌòÑÏû¨ Î†àÎ≤®ÏóêÏÑú Ï∂úÎ†•Ìï† ÎåìÍ∏Ä Î¶¨Ïä§Ìä∏
               - level    : Îì§Ïó¨Ïì∞Í∏∞/Ïä§ÌÉÄÏùº Îã®Í≥Ñ (0 = ÏµúÏÉÅÏúÑ, 1 Ïù¥ÏÉÅ = ÎåÄÎåìÍ∏ÄÎì§)
        =================================================================== -->
        <div th:fragment="commentThread(comments, level)">
            <div th:each="comment : ${comments}">

                <!-- Ìïú Í∞úÏùò ÎåìÍ∏Ä Ïπ¥Îìú -->
                <div class="comment-item"
                     th:classappend="${level > 0} ? ' comment-reply-item'">

                    <!-- Î©îÌÉÄ Ï†ïÎ≥¥ -->
                    <div class="comment-meta">

                        <!-- ÏôºÏ™Ω: ÏûëÏÑ±Ïûê/ÏãúÍ∞Ñ/(ÎãµÍ∏Ä) -->
                        <div class="comment-meta-left">
                            <span class="comment-author"
                                  th:text="${comment.author != null ? comment.author.username : 'ÏùµÎ™Ö'}">
                                ÏûëÏÑ±Ïûê
                            </span>

                            <span class="comment-dot">¬∑</span>

                            <!-- level > 0 Ïù¥Î©¥ (ÎãµÍ∏Ä) Î±ÉÏßÄ ÌëúÏãú -->
                            <span class="comment-badge"
                                  th:if="${level > 0}">
                                (ÎãµÍ∏Ä)
                            </span>

                            <span class="comment-time"
                                  th:text="${#temporals.format(comment.createDate, 'yyyy.MM.dd HH:mm')}">
                                2025.01.01 13:00
                            </span>
                        </div>

                        <!-- Ïò§Î•∏Ï™Ω: ÏàòÏ†ï/ÏÇ≠Ï†ú/ÎãµÍ∏Ä -->
                        <div class="comment-meta-right">

                            <!-- ÏàòÏ†ï/ÏÇ≠Ï†ú: Î°úÍ∑∏Ïù∏ + Î≥∏Ïù∏ ÎåìÍ∏Ä -->
                            <span class="comment-actions"
                                  sec:authorize="isAuthenticated()">
                                <span th:if="${comment.author != null
                                              and comment.author.username == #authentication.name}">

                                    <a th:href="@{|/comments/modify/${comment.id}|}"
                                       class="comment-edit-link">
                                        ÏàòÏ†ï
                                    </a>

                                    <a th:href="@{|/comments/delete/${comment.id}|}"
                                       class="comment-delete-link"
                                       onclick="return confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">
                                        ÏÇ≠Ï†ú
                                    </a>

                                </span>
                            </span>

                            <!-- ÎãµÍ∏Ä Î≤ÑÌäº: Î°úÍ∑∏Ïù∏Îßå ÎêòÏñ¥ ÏûàÏúºÎ©¥ ÎàÑÍµ¨ÎÇò -->
                            <button type="button"
                                    class="comment-reply-toggle-btn"
                                    onclick="toggleReplyForm(this)"
                                    sec:authorize="isAuthenticated()">
                                ÎãµÍ∏Ä
                            </button>
                        </div>
                    </div>

                    <!-- ÎåìÍ∏Ä ÎÇ¥Ïö© -->
                    <p class="comment-content"
                       th:text="${comment.content}">
                        ÎåìÍ∏Ä ÎÇ¥Ïö©
                    </p>

                    <!-- Ïù¥ ÎåìÍ∏ÄÏóê ÎåÄÌïú ÎãµÍ∏Ä ÏûëÏÑ± Ìèº (ÎåÄÎåìÍ∏Ä/ÎåÄÎåÄÎåìÍ∏Ä/... Í≥µÌÜµ) -->
                    <form class="comment-form reply-form"
                          th:action="@{|/comments/create/${post.id}|}"
                          method="post"
                          style="display:none;">

                        <input type="hidden"
                               th:name="${_csrf.parameterName}"
                               th:value="${_csrf.token}"/>

                        <!-- Î∂ÄÎ™® ÎåìÍ∏Ä ID: ÏßÄÍ∏à Î†åÎçîÎßÅ Ï§ëÏù∏ comment.id -->
                        <input type="hidden" name="parentId" th:value="${comment.id}"/>

                        <textarea class="comment-textarea"
                                  name="content"
                                  rows="2"
                                  placeholder="ÎãµÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>

                        <div class="comment-form-footer">
                            <button type="submit" class="comment-submit-btn">Îì±Î°ù</button>
                        </div>
                    </form>
                </div>

                <!-- üîÅ ÏûêÏãù ÎåìÍ∏Ä(replies)Ïù¥ ÏûàÏúºÎ©¥, Í∞ôÏùÄ fragmentÎ•º Ïû¨Í∑Ä Ìò∏Ï∂ú -->
                <div class="comment-replies"
                     th:if="${comment.replies != null and !#lists.isEmpty(comment.replies)}"
                     th:insert="~{::commentThread(${comment.replies}, ${level + 1})}">
                </div>

            </div>
        </div>

    </section>
</div>

<!-- ÌéòÏù¥ÏßÄ Ï†ÑÏö© JS -->
<th:block th:fragment="scripts">
    <script defer th:src="@{/js/postdetail.js}"></script>
</th:block>

</html>
